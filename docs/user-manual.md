# CONTAM-Next 用户手册

> 版本 2.5D | 2026-02-16

---

## 目录

1. [概述](#1-概述)
2. [安装与启动](#2-安装与启动)
3. [界面总览](#3-界面总览)
4. [快速入门：构建第一个模型](#4-快速入门构建第一个模型)
5. [楼层管理](#5-楼层管理)
6. [绘制墙壁与创建房间](#6-绘制墙壁与创建房间)
7. [放置门窗与气流组件](#7-放置门窗与气流组件)
8. [气流元件参数详解](#8-气流元件参数详解)
9. [区域与墙壁属性编辑](#9-区域与墙壁属性编辑)
10. [污染物与源](#10-污染物与源)
11. [排程系统](#11-排程系统)
12. [控制系统](#12-控制系统)
13. [空调系统 (AHS)](#13-空调系统-ahs)
14. [人员暴露评估](#14-人员暴露评估)
15. [运行仿真与查看结果](#15-运行仿真与查看结果)
16. [文件操作与库管理](#16-文件操作与库管理)
17. [底图追踪与比例尺](#17-底图追踪与比例尺)
18. [键盘快捷键](#18-键盘快捷键)
19. [CLI 与 Python API](#19-cli-与-python-api)
20. [已知限制与后续计划](#20-已知限制与后续计划)

---

## 1. 概述

CONTAM-Next 是 NIST CONTAM 多区域气流与污染物传输仿真软件的现代重构版本。

**技术栈**：C++17 计算引擎 + Tauri 2.0 桌面框架 + React 19 + TypeScript 5.9

**核心能力**：

- 2.5D 画布式建筑平面图编辑器（Excalidraw 风格无限画布）
- 画墙围合自动生成房间（平面图最小循环检测算法）
- 10 种气流路径元件：门、窗、开口、裂缝、风机、风管、风阀、过滤器、自调节通风口、单向阀
- 稳态气流求解：Newton-Raphson + 信赖域/亚松弛
- 瞬态污染物传输：隐式欧拉时间积分 + 自适应步长
- 控制系统：传感器 → PI 控制器（死区+抗饱和）→ 执行器
- 人员暴露评估：累积吸入剂量 + 峰值浓度跟踪
- 多楼层支持：独立几何 + 基于标高的烟囱效应
- 结果可视化：流量箭头、压力标签、浓度热力图、风压矢量
- Python API（pybind11）支持批量仿真

---

## 2. 安装与启动

### 2.1 引擎编译（C++17）

```bash
cd contam-next/engine
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
cmake --build . --config Release
```

依赖通过 CMake FetchContent 自动下载：Eigen3、nlohmann-json、Google Test。

### 2.2 前端开发

```bash
cd contam-next/app
npm install
npm run dev          # Vite 开发服务器（浏览器模式）
npm run tauri dev    # Tauri 桌面窗口（完整功能）
```

### 2.3 Python API

```bash
cd contam-next/python
pip install pybind11
python setup.py build_ext --inplace
```

> **注意**：浏览器模式下仿真使用模拟数据；完整 C++ 引擎求解需要 Tauri 桌面模式。

---

## 3. 界面总览

CONTAM-Next 采用浮动面板布局，所有 UI 元素悬浮在全屏画布之上。

### 3.1 布局结构

```
┌─────────────────────────────────────────────────────┐
│  [TopBar: 仿真按钮 | 撤销/重做 | 导出 | 保存/打开]    │
│  ┌──────┐                        ┌──────────────┐   │
│  │垂直  │    ┌─[视图切换]─┐      │ 楼层切换器   │   │
│  │工具栏│    │2D画布|控制网络│    │ 底图控制     │   │
│  │      │    └────────────┘      │              │   │
│  │ 选择 │                        │              │   │
│  │ 画墙 │                        │  属性面板    │   │
│  │ 矩形 │      [画布区域]         │  (右侧栏)   │   │
│  │ 门   │                        │  340px 宽    │   │
│  │ 窗   │                        │              │   │
│  │ 删除 │                        │              │   │
│  └──────┘                        └──────────────┘   │
│           ┌──[比例尺]    [缩放控制]──┐               │
│           └──────────────────────────┘               │
│  ┌──────────[底部面板: 结果表格/图表]──────────┐      │
│  └────────────────────────────────────────────┘      │
│  [状态栏: 工具名 | 坐标 X,Y | 墙数/区域数/楼层]      │
└─────────────────────────────────────────────────────┘
```

### 3.2 两个视图

- **2D 画布**：建筑平面图编辑器，用于绘制墙壁、放置组件、查看仿真结果
- **控制网络**：React Flow 节点图编辑器，用于可视化搭建传感器→控制器→执行器 DAG

通过顶部居中的标签页切换。

### 3.3 右侧属性面板

属性面板有两种模式：

**选中元素时**：显示该元素的属性编辑器
- 选中区域（房间）→ 名称、温度、体积
- 选中墙壁 → 长度、高度、类型（内墙/外墙）、已放置组件列表
- 选中组件（门/窗等）→ 元件类型、流动参数、标高、倍率

**未选中时**：显示 9 个配置标签页

| 标签 | 功能 |
|------|------|
| 模型 | 楼层设置、室外环境参数、模型概览 |
| 污染物 | 污染物种类 + 源/汇 + 瞬态配置 |
| 排程 | 时间表编辑 + 周计划 |
| 控制 | 传感器、执行器、PI 控制器 |
| 人员 | 人员暴露追踪配置 |
| 气象 | 气象文件 (.wth) 导入 |
| 空调 | 空气处理系统 (AHS) |
| 过滤器 | 高级过滤器模型 |
| 库管理 | 导入/导出可复用组件库 |

---

## 4. 快速入门：构建第一个模型

以一个两房间办公室为例，演示从零到仿真的完整流程。

### 步骤 1：绘制房间

1. 启动应用，在欢迎页点击「新建项目」
2. 按 `3`（矩形工具），在画布上拖拽绘制第一个房间（如 5m × 4m）
3. 再次拖拽绘制第二个房间，使其与第一个房间共享一面墙

> **提示**：当两个矩形共享顶点时，系统自动识别共享墙为内墙，两侧各生成一个独立房间。

### 步骤 2：放置门

1. 按 `4`（门工具）
2. 点击两个房间之间的共享墙 → 门自动放置在点击位置
3. 门图标显示为琥珀色表示「未配置」，点击门打开属性面板
4. 设置流量系数 C = 0.65、面积 = 1.8 m² → 图标变为正常颜色

### 步骤 3：外墙开口

1. 右键点击外墙 → 选择「在墙上放置 → 裂缝」
2. 在属性面板设置 C = 0.0001、n = 0.65（模拟外墙渗透）

### 步骤 4：设置环境参数

1. 点击画布空白处取消选择 → 属性面板切换到标签页模式
2. 选择「模型」标签 → 设置室外温度（如 10°C）、风速、风向
3. 点击各房间设置室内温度（如 22°C）

### 步骤 5：运行仿真

1. 点击顶部工具栏「稳态求解」按钮
2. 等待求解完成（画布显示加载遮罩）
3. 结果自动显示：
   - 画布上出现流量箭头和压力标签
   - 底部面板展开显示节点压力表和路径流量表
   - 鼠标悬停在房间/墙壁上显示详细数据

### 步骤 6：添加污染物（可选，进入瞬态仿真）

1. 属性面板 →「污染物」标签 → 点击「CO₂」快速添加
2. 添加源：选择房间、选择 CO₂、设置恒定释放率
3. 配置瞬态参数：开始时间 0s、结束时间 3600s、步长 10s
4. 点击「瞬态仿真」→ 底部面板显示浓度-时间曲线

---

## 5. 楼层管理

### 5.1 楼层切换器

画布右上角的浮动面板显示所有楼层按钮。

- 点击楼层编号切换到该层
- `PageUp` / `PageDown` 快速上下切换
- 点击 `+` 添加新楼层

### 5.2 楼层属性

每个楼层拥有独立的：
- 几何数据（墙壁、顶点、面）
- 组件放置（门、窗等）
- 区域分配（房间名称、温度、颜色）
- 背景底图

在属性面板「模型」标签中可编辑：
- 楼层名称（首层、第 2 层、第 3 层...）
- 层高（默认 3.0m）

### 5.3 楼层标高

引擎中每层的标高 = `层号 × 层高`：
- 首层 (level=0)：0m
- 第 2 层 (level=1, 层高 3m)：3m
- 第 3 层 (level=2, 层高 3m)：6m

标高差异驱动烟囱效应（热压）计算。

### 5.4 注意事项

- 新楼层为空白画布，不会复制下层几何（可导入底图作为描图参考）
- 当前版本楼层间的竖向连通（竖井/楼梯间）需通过 JSON 手动配置（参见[已知限制](#20-已知限制与后续计划)）

---

## 6. 绘制墙壁与创建房间

### 6.1 画墙工具（快捷键 `2` 或 `W`）

**两次点击工作流**：

1. 第一次点击设定墙壁起点（自动吸附到网格和已有顶点）
2. 移动鼠标 → 显示虚线预览 + 长度标注（如 `3.50m`）
3. 第二次点击确认墙壁终点

**正交约束**：墙壁自动锁定为水平或垂直方向（取决于鼠标偏移方向）。

**顶点吸附**：当鼠标靠近已有顶点（12 像素范围内）时自动吸附，确保墙壁精确连接。

**自动生成房间**：当墙壁围合成封闭多边形时，系统自动检测并创建房间区域，分配默认名称（「房间 1」「房间 2」...）和颜色。

### 6.2 矩形工具（快捷键 `3` 或 `R`）

**拖拽工作流**：

1. 第一次点击设定矩形左上角
2. 移动鼠标 → 显示虚线矩形预览 + 宽高标注
3. 第二次点击确认右下角 → 一次性创建 4 面墙

最小尺寸：0.3m × 0.3m。

> **技巧**：用矩形工具快速创建房间，再用画墙工具添加内部隔墙进行分隔。

### 6.3 共享墙与房间检测

- 两个相邻矩形共享顶点时，共享边自动识别为**内墙**
- 仅有一侧有房间的墙壁识别为**外墙**（连接室外环境）
- 内墙上放置的组件连接两侧房间；外墙上的组件连接房间与室外

### 6.4 删除工具（快捷键 `6` 或 `E`）

切换到删除模式后，点击墙壁或组件即可删除。删除墙壁会触发房间重新检测。

也可以选中元素后按 `Delete` 键删除。

---

## 7. 放置门窗与气流组件

### 7.1 放置方式

**方式一：工具栏**
- 按 `4`（门工具）或 `5`（窗工具）→ 点击墙壁放置

**方式二：右键菜单**（支持全部 10 种类型）
- 右键点击墙壁 →「在墙上放置」→ 选择组件类型
- 组件放置在墙壁中点（alpha = 0.5）

### 7.2 组件类型

| 分类 | 类型 | 说明 |
|------|------|------|
| **开口** | 门 (door) | 大开口双向流模型，带 90° 弧形图标 |
| | 窗 (window) | 幂律孔口模型，双平行线图标 |
| | 裂缝 (crack) | 幂律孔口模型，模拟墙体渗透 |
| **HVAC** | 风机 (fan) | 线性/多项式风机曲线 |
| | 风管 (duct) | Darcy-Weisbach 管道模型 |
| | 风阀 (damper) | 可调开度阀门 |
| | 过滤器 (filter) | 带污染物去除效率 |
| | 自调节通风口 (srv) | 恒流量通风口 |
| | 单向阀 (checkValve) | 仅允许单向流动 |

### 7.3 配置状态

- **琥珀色图标**：未配置（使用默认参数）— 仿真时会显示警告
- **正常颜色图标**：已配置 — 修改任意参数后自动标记为已配置

### 7.4 连通性规则

组件放置在墙壁上后，自动建立气流路径连接：

- **内墙上的组件**：连接墙壁两侧的房间（如「办公室 ⟷ 走廊」）
- **外墙上的组件**：连接房间与室外环境（如「办公室 → 室外」）

属性面板中会显示连通关系，如：`房间 1 ⟷ 房间 2`。

---

## 8. 气流元件参数详解

### 8.1 门 / 大开口双向流 (TwoWayFlow)

适用于门、大窗等大面积开口。

$$\dot{m} = \rho \cdot C_d \cdot A \cdot \sqrt{2|\Delta P|/\rho} \cdot \text{sign}(\Delta P)$$

| 参数 | 说明 | 默认值 |
|------|------|--------|
| Cd | 流量系数 | 0.65 |
| area | 开口面积 (m²) | 1.8 |

### 8.2 窗 / 裂缝 / 幂律孔口 (PowerLawOrifice)

适用于窗户、墙体裂缝、小型开口。

$$\dot{m} = \rho \cdot C \cdot |\Delta P|^n \cdot \text{sign}(\Delta P)$$

| 参数 | 说明 | 典型值 |
|------|------|--------|
| C | 流动系数 m³/(s·Pa^n) | 窗: 0.001, 裂缝: 0.0001 |
| n | 流动指数 | 0.5~1.0 (0.65 典型) |

### 8.3 风机 (Fan)

**线性模式**：$Q = Q_{max} \cdot (1 - \Delta P / P_{shutoff})$

**多项式模式**：$\Delta P = a_0 + a_1 Q + a_2 Q^2 + \cdots$

| 参数 | 说明 | 默认值 |
|------|------|--------|
| maxFlow | 最大流量 (m³/s) | 0.05 |
| shutoffPressure | 截止压力 (Pa) | 200 |

### 8.4 风管 (Duct)

Darcy-Weisbach + Swamee-Jain 摩擦系数自动计算。

| 参数 | 说明 | 默认值 |
|------|------|--------|
| length | 管长 (m) | 5 |
| diameter | 管径 (m) | 0.2 |
| roughness | 粗糙度 (m) | 0.0001 (镀锌钢) |
| sumK | 局部损失系数 | 0 |

### 8.5 风阀 (Damper)

$$\dot{m} = \rho \cdot C_{max} \cdot f \cdot |\Delta P|^n \cdot \text{sign}(\Delta P)$$

| 参数 | 说明 | 默认值 |
|------|------|--------|
| Cmax | 全开流量系数 | 0.005 |
| fraction | 开度 (0~1) | 1.0 |

可绑定排程或控制系统执行器动态调节开度。

### 8.6 过滤器 (Filter)

气流阻力同幂律孔口，附加污染物去除：$C_{out} = C_{in} \cdot (1 - \eta)$

| 参数 | 说明 | 默认值 |
|------|------|--------|
| C | 流动系数 | 0.002 |
| efficiency | 去除效率 (0~1) | 0.9 |

高级过滤器模型（属性面板「过滤器」标签）：
- **SimpleGaseousFilter**：含穿透阈值和加载-效率曲线
- **UVGIFilter**：紫外线杀菌，含辐照度、腔体体积、老化参数
- **SuperFilter**：级联多级过滤器

### 8.7 自调节通风口 (SelfRegulatingVent)

在压差范围内维持恒定流量。

| 参数 | 说明 | 默认值 |
|------|------|--------|
| targetFlow | 目标流量 (m³/s) | 0.01 |
| pMin | 最小工作压差 (Pa) | 2 |
| pMax | 最大工作压差 (Pa) | 50 |

### 8.8 单向阀 (CheckValve)

仅允许正向流动，反向流量为零。

| 参数 | 说明 | 默认值 |
|------|------|--------|
| C | 流动系数 | 0.001 |
| n | 流动指数 | 0.65 |

---

## 9. 区域与墙壁属性编辑

### 9.1 区域（房间）属性

点击画布上的房间区域，右侧面板显示：

| 属性 | 说明 | 可编辑 |
|------|------|--------|
| 名称 | 房间名称（如「办公室」） | 是 |
| 温度 | 室内温度，显示 °C，存储 K | 是 |
| 体积 | 房间体积 (m³) | 是 |
| 面积 | 自动计算的地面面积 (m²) | 否 |
| 顶点数 | 围合多边形的顶点数量 | 否 |
| Zone ID | 内部标识符 | 否 |
| 颜色 | 区域填充色（自动分配） | 否 |

### 9.2 墙壁属性

点击墙壁，右侧面板显示：

| 属性 | 说明 |
|------|------|
| 长度 | 墙壁长度 (m) |
| 高度 | 层高 (m) |
| 厚度 | 墙壁厚度 (m) |
| 类型 | 外墙（仅一侧有房间）或内墙（两侧有房间） |
| 连接区域 | 墙壁两侧的房间名称（带方向箭头） |
| 已放置组件 | 该墙壁上所有组件的列表（可点击选中） |

组件列表中：
- 绿色圆点 = 已配置
- 红色圆点 = 未配置（使用默认参数）

### 9.3 悬浮信息框

鼠标悬停在画布元素上时，光标旁显示悬浮信息框：

**编辑模式**：
- 区域：名称、面积、温度、体积
- 墙壁：类型（内墙/外墙）、长度、连接区域、组件数量

**结果模式**（仿真完成后）：
- 区域：压力 (Pa)、密度 (kg/m³)、温度 (°C)、换气次数 (ACH)、各污染物浓度
- 墙壁：质量流量 (kg/s)、压差 (Pa)、流向、过滤效率

---

## 10. 污染物与源

在属性面板「污染物」标签中配置。

### 10.1 污染物种类

提供 5 种快速添加模板：

| 模板 | 摩尔质量 (kg/mol) | 衰减率 (1/s) | 室外浓度 |
|------|-------------------|-------------|----------|
| CO | 0.028 | 0 | 0 |
| CO₂ | 0.044 | 0 | 7.2×10⁻⁴ kg/m³ |
| HCHO | 0.030 | 0 | 0 |
| PM2.5 | — | 0 | 3.5×10⁻⁵ kg/m³ |
| Rn | 0.222 | 2.1×10⁻⁶ | 0 |

也可手动添加自定义种类，设置摩尔质量、衰减率和室外本底浓度。

### 10.2 污染源/汇

每个源绑定到一个区域和一个污染物种类。5 种源类型：

| 类型 | 说明 | 特有参数 |
|------|------|----------|
| Constant | 恒定释放 | 释放率 (kg/s) |
| ExponentialDecay | 指数衰减 | 初始释放率、时间常数 τ (s)、倍率 |
| PressureDriven | 压力驱动 | 释放率、压力系数 |
| CutoffConcentration | 浓度截止 | 释放率、截止浓度 (kg/m³) |
| Burst | 瞬时释放 | 释放质量 (kg)、触发时间 (s)、持续时间 (s) |

### 10.3 瞬态配置

定义污染物种类后，瞬态配置区域自动出现：

| 参数 | 说明 | 建议值 |
|------|------|--------|
| 开始时间 | 仿真起始 (s) | 0 |
| 结束时间 | 仿真终止 (s) | 3600 (1小时) |
| 时间步长 | 积分步长 (s) | 10 |
| 输出间隔 | 结果记录间隔 (s) | 60 |

> **注意**：定义了污染物种类后，顶部仿真按钮自动从「稳态求解」变为「瞬态仿真」。

---

## 11. 排程系统

在属性面板「排程」标签中配置。

### 11.1 时间表

每个时间表是一组 (时间, 值) 数据点，定义 24 小时内某参数的变化规律。

**预设模板**：
- 工作日 8h：08:00-18:00 值为 1，其余为 0
- 24h 恒定：全天值为 1
- 夜间通风：22:00-06:00 值为 1，其余为 0

时间表以 ECharts 折线图可视化显示，支持手动编辑数据点。

### 11.2 周计划

将时间表分配到一周七天：

1. 定义日类型（如「工作日」「周末」「假日」），每种日类型引用一个时间表
2. 为周一至周日各分配一个日类型

### 11.3 排程绑定

风机、风阀、过滤器、自调节通风口等组件可在属性面板中绑定排程，实现时变控制。

---

## 12. 控制系统

### 12.1 概述

控制系统遵循 传感器 → 控制器 → 执行器 的 DAG 结构。

```
传感器(Sensor) ──→ PI控制器(Controller) ──→ 执行器(Actuator) ──→ 气流元件
   ↑ 测量值              ↑ 计算控制量              ↑ 调节参数
```

### 12.2 传感器

在属性面板「控制」标签中添加。

| 类型 | 测量量 | 单位 |
|------|--------|------|
| Concentration | 区域污染物浓度 | kg/m³ |
| Pressure | 区域压力 | Pa |
| Temperature | 区域温度 | K |
| MassFlow | 路径质量流量 | kg/s |

每个传感器需指定目标区域（节点）。

### 12.3 执行器

| 类型 | 控制对象 | 输出范围 |
|------|----------|----------|
| DamperFraction | 风阀开度 | 0~1 |
| FanSpeed | 风机转速比 | 0~1 |
| FilterBypass | 过滤器旁通比 | 0~1 |

每个执行器需指定目标气流路径（链接）。

### 12.4 PI 控制器

$$u(t) = K_p \cdot e(t) + K_i \int_0^t e(\tau) d\tau$$

| 参数 | 说明 |
|------|------|
| setpoint | 设定值（与传感器测量量同单位） |
| Kp | 比例增益 |
| Ki | 积分增益 |
| deadband | 死区宽度（误差绝对值小于此值时不动作） |

特性：
- 输出硬截断到 [0, 1]
- 抗积分饱和：输出饱和时停止积分累积

### 12.5 控制网络可视化

切换到「控制网络」视图，可看到 React Flow 节点图：

- **绿色节点**：传感器（SensorNode）
- **紫色节点**：PI 控制器（PIControllerNode）
- **橙色节点**：执行器（ActuatorNode）
- **蓝色节点**：数学运算节点（MathNode）
- **灰色节点**：逻辑节点（LogicNode）

节点之间的连线表示信号流向。

---

## 13. 空调系统 (AHS)

在属性面板「空调」标签中配置。

### 13.1 系统参数

| 参数 | 说明 |
|------|------|
| 名称 | AHS 系统名称 |
| 送风量 | 总送风流量 (m³/s) |
| 回风量 | 总回风流量 (m³/s) |
| 新风量 | 室外新风流量 (m³/s) |
| 排风量 | 排风流量 (m³/s) |
| 送风温度 | 送风温度 (K) |

### 13.2 区域连接

- **送风连接**：选择区域 + 分配比例（所有送风区域比例之和应为 1）
- **回风连接**：选择区域 + 分配比例

### 13.3 排程绑定

- 送风量排程：控制送风量随时间变化
- 新风量排程：控制新风比例随时间变化

系统自动检查风量平衡并显示警告。

---

## 14. 人员暴露评估

在属性面板「人员」标签中配置。

### 14.1 人员参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| 名称 | 人员标识 | — |
| 呼吸率 | 呼吸流量 (m³/s) | 1.2×10⁻⁴ (静息) |
| CO₂ 排放率 | CO₂ 呼出率 (kg/s) | 3.3×10⁻⁶ |

### 14.2 移动计划

每个人员可配置时间-区域移动计划：在不同时间段停留在不同房间。

> 当模型中存在 CO₂ 种类时，人员自动注入 CO₂ 源到所在区域。

### 14.3 暴露报告

仿真完成后，底部面板「暴露报告」标签显示：

| 指标 | 说明 |
|------|------|
| 累积吸入剂量 | Σ(呼吸率 × 浓度 × Δt) (kg) |
| 峰值浓度 | 最大瞬时浓度 (kg/m³) |
| 时间加权平均 | 平均暴露浓度 (kg/m³) |

若未定义人员，系统自动为每个非室外区域生成默认人员。

---

## 15. 运行仿真与查看结果

### 15.1 模型验证

点击仿真按钮前，系统自动验证模型：

| 级别 | 条件 | 处理 |
|------|------|------|
| 错误 | 模型为空（无区域、无节点） | 阻止仿真 |
| 警告 | 存在未配置的组件 | 允许仿真，使用默认参数 |
| 警告 | 存在孤立区域（无气流路径） | 允许仿真，该区域与外界隔绝 |

### 15.2 稳态求解

当未定义污染物种类时，按钮显示「稳态求解」。

求解 Newton-Raphson 非线性方程组，输出：
- 各区域压力 (Pa)、密度 (kg/m³)、温度 (°C)、换气次数 (ACH)
- 各路径质量流量 (g/s)、体积流量 (L/s)

### 15.3 瞬态仿真

当定义了污染物种类时，按钮显示「瞬态仿真」。

在每个时间步：先求解气流网络，再用隐式欧拉积分污染物传输方程。

输出：各区域各时间步的压力和浓度时序数据。

### 15.4 结果显示

#### 画布叠加层（自动出现）

| 叠加层 | 说明 |
|--------|------|
| 流量箭头 | 垂直于墙壁，长度正比于流量，蓝色=正向，红色=反向 |
| 压力标签 | 墙壁中点显示压差 ΔP (Pa)（缩放 > 30 时可见） |
| 浓度热力图 | 区域填充绿-黄-红渐变色，标注浓度值 (ppm) |
| 风压矢量 | 外墙上显示风压系数 Cp，橙色=正压，青色=负压 |

#### 底部面板

三个标签页：

**稳态结果**：两列表格
- 节点表：名称、压力、密度、温度、ACH
- 路径表：路径（从→到）、质量流量、体积流量
- 显示收敛状态、迭代次数、最大残差

**瞬态图表**：两个 ECharts 折线图
- 浓度图：各区域各种类浓度随时间变化，支持单位切换（kg/m³、mg/m³、μg/m³、ppm）
- 压力图：各区域压力随时间变化
- 内置安全参考线：CO₂ 1000ppm、CO 25ppm、HCHO 0.08mg/m³、PM2.5 35/75μg/m³
- 支持图表内缩放

**暴露报告**：人员暴露数据表（参见第 14 节）

所有结果均可导出为 CSV 文件。

### 15.5 瞬态结果回放

底部居中的时间步进器（TimeStepper）提供播放控制：

| 控件 | 功能 |
|------|------|
| ⏮ | 跳到第一步 |
| ◀ | 上一步 |
| ▶/⏸ | 播放/暂停 |
| ▶ | 下一步 |
| ⏭ | 跳到最后一步 |
| 滑块 | 拖拽到任意时间点 |
| 速度 | 0.5x / 1x / 2x / 4x |
| 返回编辑 | 退出结果模式，回到编辑模式 |

播放时画布上的流量箭头和浓度热力图实时更新。

---

## 16. 文件操作与库管理

### 16.1 保存与打开

- **保存** (TopBar 右侧)：导出为 `.contam.json` 文件
  - Tauri 模式：原生文件对话框
  - 浏览器模式：自动下载
- **打开** (TopBar 右侧)：导入 `.contam.json` 或 `.json` 文件
- **清空**：确认对话框后清除所有数据（不可撤销）

> 支持拖放文件到窗口直接打开。

### 16.2 CSV 导出

仿真完成后，TopBar 出现「导出 CSV」按钮：
- 稳态：节点压力 + 路径流量
- 瞬态：时序浓度 + 压力数据

各结果面板也有独立的 CSV 导出按钮。

### 16.3 库管理

属性面板「库管理」标签提供组件库的导入/导出功能。

**四种库类型**：
- 气流元件
- 风机曲线
- 过滤器
- 日程表

**导出**：从当前项目中选择组件 → 导出为 JSON 库文件
**导入**：加载 JSON 库文件 → 选择组件 → 导入到当前项目

支持搜索、全选/取消、预览详情。

---

## 17. 底图追踪与比例尺

### 17.1 底图导入

画布右上角「底图追踪」面板：

1. 点击「导入底图」→ 选择 PNG/JPG/BMP 图片
2. 调整透明度（0~100%）
3. 设置旋转角度（0°/90°/180°/270°）
4. 锁定底图防止误操作

### 17.2 底图标定（两点校准）

1. 点击「标定」按钮
2. 在底图上点击第一个标定点
3. 点击第二个标定点
4. 输入两点间的实际距离（米）
5. 系统自动计算像素/米比例

### 17.3 比例尺设置

画布左下角「比例尺」面板：

**预设比例**：
- 1:1 → 1 格 = 1m
- 1:10 → 1 格 = 10cm
- 1:100 → 1 格 = 1cm
- 10:1 → 1 格 = 10m

**手动输入**：自定义每格代表的实际距离。

**两点校准**：在画布上点击两点，输入实际距离，自动计算比例尺。

比例尺影响：
- 画布上的尺寸标注
- 导出到引擎的所有几何尺寸（长度 ×sf、面积 ×sf²、体积 ×sf³）

---

## 18. 键盘快捷键

按 `?` 键打开快捷键面板。

### 18.1 工具切换

| 快捷键 | 功能 |
|--------|------|
| `1` 或 `V` | 选择工具 |
| `2` 或 `W` | 画墙工具（正交） |
| `3` 或 `R` | 矩形房间工具 |
| `4` 或 `D` | 放置门 |
| `5` | 放置窗 |
| `6` 或 `E` | 删除工具 |

### 18.2 画布操作

| 快捷键 | 功能 |
|--------|------|
| `Space`（按住） | 临时平移模式 |
| 鼠标滚轮 | 缩放（以光标为中心） |
| 左键拖拽空白区域 | 平移画布 |
| 中键拖拽 | 平移画布 |
| 右键 | 上下文菜单 |

### 18.3 编辑操作

| 快捷键 | 功能 |
|--------|------|
| `Delete` 或 `Backspace` | 删除选中元素 |
| `Escape` | 取消当前操作 / 清除选择 |
| `Ctrl+Z` | 撤销 |
| `Ctrl+Shift+Z` | 重做 |

### 18.4 导航

| 快捷键 | 功能 |
|--------|------|
| `PageUp` | 上一楼层 |
| `PageDown` | 下一楼层 |
| `?` | 显示快捷键面板 |

---

## 19. CLI 与 Python API

### 19.1 命令行引擎

```bash
contam_engine -i input.json -o output.json -v           # 稳态求解
contam_engine -i input.json -o output.json --transient   # 瞬态仿真
```

### 19.2 JSON 输入格式

最小示例：

```json
{
  "nodes": [
    { "id": 0, "name": "室外", "type": "ambient", "temperature": 283.15 },
    { "id": 1, "name": "办公室", "temperature": 293.15, "volume": 50 }
  ],
  "links": [
    {
      "id": 1, "from": 0, "to": 1, "elevation": 1.0,
      "element": { "type": "PowerLawOrifice", "C": 0.003, "n": 0.65 }
    }
  ]
}
```

完整 Schema 参见 `schemas/topology.schema.json`。

### 19.3 Python API

```python
import contam

# 创建网络
net = contam.Network()
net.addNode(contam.Node(0, "室外", contam.NodeType.Ambient, 283.15))
net.addNode(contam.Node(1, "办公室", contam.NodeType.Normal, 293.15, 50.0))

# 添加气流路径
orifice = contam.PowerLawOrifice(0.003, 0.65)
net.addLink(contam.Link(1, 0, 1, 1.0, orifice))

# 求解
solver = contam.Solver()
solver.solve(net)

# 读取结果
print(f"办公室压力: {net.getNode(1).getPressure():.4f} Pa")
```

Python 绑定还支持：
- 控制系统（Sensor, Controller, Actuator, 15 种 LogicNode）
- 人员暴露（Occupant）
- AHS 系统（SimpleAHS, ZoneConnection）
- 报告生成（ValReport, EbwReport, CexReport, LogReport, OneDOutput）

---

## 20. 已知限制与后续计划

### 20.1 当前限制

| 限制 | 说明 |
|------|------|
| 楼层间竖向连通 | 竖井/楼梯间跨楼层连接尚未在画布 UI 中实现，需通过 JSON 手动配置 |
| 新楼层为空白 | 添加新楼层不会复制下层几何，需重新绘制或使用底图描图 |
| 单一连通区域 | `rebuildFaces` 仅支持单一连通区域，不支持完全孤立的房间 |
| 无 CFD 耦合 | 不支持 CFD 区域耦合仿真 |
| 无联合仿真 | 不支持 FMI/TCP Socket Bridge 联合仿真 |
| 楼层标高计算 | 使用 `层号 × 本层层高`，非累积计算（混合层高时可能不准确） |

### 20.2 验证案例

| 案例 | 描述 | 节点 | 路径 |
|------|------|------|------|
| case01 | 三房间烟囱效应 | 3 | 3 |
| case02 | CO₂ 源瞬态 1 小时 | 2 | 2 |
| case03 | 风扇+风管+大开口 | 3 | 4 |
| case04 | 全元件 + 2 物种 | 4 | 8 |

验证文件位于 `engine/test/` 目录，共 182+ GoogleTest 用例。

### 20.3 后续计划

- 竖井/楼梯间 UI 工具（跨楼层竖向连通）
- 楼层几何复制功能
- 示例模型库
- 用户引导教程
- 国际化（中英文切换）
- CFD 区域耦合接口
- FMI 联合仿真支持
