name: CONTAM-Next CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  # ── C++ Engine Tests (all platforms) ─────────────────────────────
  engine-tests:
    strategy:
      matrix:
        include:
          - os: windows-latest
            name: Windows
            test-bin: engine/build/Release/contam_tests.exe
            engine-bin: engine/build/Release/contam_engine.exe
          - os: ubuntu-latest
            name: Linux
            test-bin: engine/build/contam_tests
            engine-bin: engine/build/contam_engine
          - os: macos-latest
            name: macOS
            test-bin: engine/build/contam_tests
            engine-bin: engine/build/contam_engine
    runs-on: ${{ matrix.os }}
    name: C++ Tests (${{ matrix.name }})
    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -S engine -B engine/build -DCMAKE_BUILD_TYPE=Release

      - name: Build Engine
        run: cmake --build engine/build --config Release

      - name: Run 130 Unit Tests
        run: ${{ matrix.test-bin }} --gtest_output=xml:engine/build/test-results.xml

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.name }}
          path: engine/build/test-results.xml

  # ── Frontend Check ───────────────────────────────────────────────
  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: app/package-lock.json
      - run: npm ci
        working-directory: app
      - run: npx tsc --noEmit
        working-directory: app
      - run: npm run build
        working-directory: app

  # ── macOS Desktop App (.dmg) ─────────────────────────────────────
  build-macos:
    runs-on: macos-latest
    needs: [engine-tests, frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build C++ Engine
        run: |
          cmake -S engine -B engine/build -DCMAKE_BUILD_TYPE=Release
          cmake --build engine/build --config Release -j$(sysctl -n hw.ncpu)

      - name: Run C++ Tests (130 tests)
        run: engine/build/contam_tests --gtest_print_time=0

      - name: Prepare engine binary for Tauri
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "arm64" ]; then
            TARGET="aarch64-apple-darwin"
          else
            TARGET="x86_64-apple-darwin"
          fi
          cp engine/build/contam_engine "app/src-tauri/contam_engine-${TARGET}"
          chmod +x "app/src-tauri/contam_engine-${TARGET}"
          echo "Prepared binary for $TARGET"

      - name: Install frontend dependencies
        working-directory: app
        run: npm ci

      - name: Build Tauri App (macOS .dmg)
        working-directory: app
        run: npx tauri build

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: CONTAM-Next-macOS
          path: app/src-tauri/target/release/bundle/dmg/*.dmg
          retention-days: 30

  # ── Windows Desktop App (.exe installer) ─────────────────────────
  build-windows:
    runs-on: windows-latest
    needs: [engine-tests, frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build C++ Engine
        run: |
          cmake -S engine -B engine/build -DCMAKE_BUILD_TYPE=Release
          cmake --build engine/build --config Release

      - name: Run C++ Tests (130 tests)
        run: engine/build/Release/contam_tests.exe --gtest_print_time=0

      - name: Prepare engine binary for Tauri
        run: |
          Copy-Item "engine/build/Release/contam_engine.exe" "app/src-tauri/contam_engine-x86_64-pc-windows-msvc.exe"

      - name: Install frontend dependencies
        working-directory: app
        run: npm ci

      - name: Build Tauri App (Windows NSIS + MSI)
        working-directory: app
        run: npx tauri build

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: CONTAM-Next-Windows
          path: |
            app/src-tauri/target/release/bundle/nsis/*.exe
            app/src-tauri/target/release/bundle/msi/*.msi
          retention-days: 30
